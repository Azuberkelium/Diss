<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Dissertation Progress Tracker</title>
    <script src="https://cdn.tailwindcss.com"></script>
    <script src="https://cdn.jsdelivr.net/npm/chart.js@4.4.0/dist/chart.umd.min.js"></script>
    <style>
        :root {
            color-scheme: light;
        }

        .dark {
            color-scheme: dark;
        }

        body {
            font-family: Copperplate, 'Copperplate Gothic Light', serif;
            background-color: #f3f4f6;
            display: flex;
            justify-content: center;
            align-items: flex-start;
            min-height: 100vh;
            padding: 2rem;
            transition: background-color 0.3s ease;
        }
        
        body.dark {
            background-color: #1a1a2e;
        }

        .container {
            background-color: #ffffff;
            padding: 2.5rem;
            border-radius: 1.5rem;
            box-shadow: 0 10px 25px rgba(0, 0, 0, 0.1);
            width: 100%;
            max-width: 900px;
            transition: background-color 0.3s ease, box-shadow 0.3s ease;
        }
        
        .container.dark {
            background-color: #162447;
            box-shadow: 0 10px 25px rgba(0, 0, 0, 0.3);
        }

        .key-item {
            display: flex;
            align-items: center;
            gap: 0.75rem;
            font-size: 0.875rem;
            color: #4b5563;
        }
        .dark .key-item {
            color: #a8a8c4;
        }

        .key-color {
            width: 1rem;
            height: 1rem;
            border-radius: 0.25rem;
        }

        .progress-list {
            list-style: none;
            padding-left: 1.5rem;
            position: relative;
        }

        .progress-list::before {
            content: '';
            position: absolute;
            left: 0;
            top: 0;
            bottom: 0;
            width: 2px;
            background-color: #d1d5db;
        }
        .dark .progress-list::before {
            background-color: #3f475d;
        }

        .progress-item {
            position: relative;
            margin-bottom: 1rem;
        }

        .progress-item::before {
            content: '';
            position: absolute;
            left: -1.5rem;
            top: 0.75rem;
            width: 1.5rem;
            height: 2px;
            background-color: #d1d5db;
        }
        .dark .progress-item::before {
            background-color: #3f475d;
        }

        .button-wrapper {
            display: flex;
            align-items: center;
            gap: 0.5rem;
            flex-wrap: wrap;
            position: relative;
        }

        .progress-button {
            padding: 0.75rem 1.25rem;
            border-radius: 0.75rem;
            font-weight: 500;
            color: #ffffff;
            transition: transform 0.1s ease, box-shadow 0.1s ease;
            cursor: pointer;
            min-width: 150px;
            text-align: left;
            position: relative;
            text-shadow: 1px 1px 2px rgba(0,0,0,0.2);
        }
        
        .progress-button:hover {
            opacity: 0.9;
        }
        
        .progress-button:active {
            transform: scale(0.98);
        }

        .progress-button span {
            display: block;
        }

        .input-group {
            display: flex;
            flex-direction: column;
            gap: 0.5rem;
            margin-left: 0.5rem;
        }
        
        .word-count-input-container {
            display: flex;
            align-items: center;
            gap: 0.25rem;
        }

        .word-count-input-container label {
            font-size: 0.875rem;
            color: #4b5563;
        }
        .dark .word-count-input-container label {
            color: #a8a8c4;
        }

        .word-count-input {
            width: 80px;
            padding: 0.25rem 0.5rem;
            border-radius: 0.5rem;
            border: 1px solid #d1d5db;
            font-size: 0.875rem;
            text-align: right;
            transition: border-color 0.2s ease, background-color 0.2s ease, color 0.2s ease;
        }
        .word-count-input:focus {
            outline: none;
            border-color: #6366f1;
            box-shadow: 0 0 0 2px rgba(99, 102, 241, 0.2);
        }
        .dark .word-count-input {
            background-color: #2e3c5a;
            border-color: #3f475d;
            color: #e5e5f0;
        }

        .action-button {
            background-color: #e5e7eb;
            color: #6b7280;
            font-weight: 500;
            padding: 0.5rem 0.75rem;
            border-radius: 0.75rem;
            cursor: pointer;
            transition: background-color 0.2s ease, color 0.2s ease;
            font-size: 0.875rem;
        }
        .action-button:hover {
            background-color: #d1d5db;
        }
        .dark .action-button {
            background-color: #344061;
            color: #e5e5f0;
        }
        .dark .action-button:hover {
            background-color: #3f475d;
        }

        .word-count-total {
            font-size: 1.5rem;
            font-weight: 700;
            color: #1f2937;
            text-align: right;
            margin-top: 1rem;
        }
        .dark .word-count-total {
            color: #e5e5f0;
        }
        
        .word-count-display {
            font-size: 0.75rem;
            font-weight: 400;
            opacity: 0.9;
        }
        
        .delete-btn {
            background-color: #fca5a5;
            color: #ffffff;
            font-size: 0.875rem;
            padding: 0.25rem 0.5rem;
            border-radius: 0.5rem;
            cursor: pointer;
            transition: background-color 0.2s ease;
            position: absolute;
            top: -0.5rem;
            right: -0.5rem;
        }
        .delete-btn:hover {
            background-color: #f87171;
        }
        .dark .delete-btn {
            background-color: #9f3636;
        }
        .dark .delete-btn:hover {
            background-color: #b94e4e;
        }
        
        /* Custom Modal for Prompts */
        .modal {
            position: fixed;
            top: 0;
            left: 0;
            width: 100%;
            height: 100%;
            background-color: rgba(0, 0, 0, 0.5);
            display: flex;
            justify-content: center;
            align-items: center;
            z-index: 100;
            opacity: 0;
            pointer-events: none;
            transition: opacity 0.3s ease;
        }
        .modal-content {
            background-color: white;
            padding: 2rem;
            border-radius: 1rem;
            box-shadow: 0 10px 20px rgba(0,0,0,0.2);
            width: 90%;
            max-width: 400px;
            transform: translateY(-20px);
            transition: transform 0.3s ease;
        }
        .dark .modal-content {
            background-color: #1f2937;
            color: #e5e5f0;
        }
        .modal.active {
            opacity: 1;
            pointer-events: auto;
        }
        .modal.active .modal-content {
            transform: translateY(0);
        }

        #help-modal .modal-content, #chart-modal .modal-content {
            max-width: 600px;
        }

        .dark-mode-toggle {
            position: absolute;
            top: 1.5rem;
            right: 1.5rem;
            background-color: #f3f4f6;
            color: #4b5563;
            padding: 0.5rem 0.75rem;
            border-radius: 0.75rem;
            cursor: pointer;
            transition: background-color 0.2s ease, color 0.2s ease;
        }
        .dark .dark-mode-toggle {
            background-color: #2e3c5a;
            color: #e5e5f0;
        }
        .dark-mode-toggle:hover {
            background-color: #d1d5db;
        }
        .dark .dark-mode-toggle:hover {
            background-color: #344061;
        }
    </style>
</head>
<body class="bg-gray-100 p-8">

    <div class="container mx-auto">
        <button id="theme-toggle" class="dark-mode-toggle">Toggle Dark Mode</button>
        <h1 class="text-3xl font-bold text-gray-800 dark:text-gray-100 mb-6 text-center">Dissertation Progress Tracker</h1>
        
        <div class="key flex justify-center gap-6 mb-8 flex-wrap">
            <div class="key-item">
                <div class="key-color bg-red-500"></div>
                <span>Not Looked At</span>
            </div>
            <div class="key-item">
                <div class="key-color bg-orange-500"></div>
                <span>Started Research</span>
            </div>
            <div class="key-item">
                <div class="key-color bg-yellow-500"></div>
                <span>1st Draft</span>
            </div>
            <div class="key-item">
                <div class="key-color bg-lime-500"></div>
                <span>2nd Draft</span>
            </div>
            <div class="key-item">
                <div class="key-color bg-green-700"></div>
                <span>Completed</span>
            </div>
        </div>
        
        <div id="progress-tree" class="space-y-4">
            <!-- Initial buttons will be generated here by JavaScript -->
        </div>

        <div class="word-count-total-container mt-8 pt-4 border-t border-gray-200 dark:border-gray-700">
            <div class="flex justify-between items-center">
                <span class="text-lg font-medium text-gray-700 dark:text-gray-300">Total Word Count:</span>
                <span id="total-word-count" class="word-count-total">0</span>
            </div>
            <p id="user-id-display" class="text-sm text-gray-500 dark:text-gray-400 mt-2 text-right hidden"></p>
            <div class="flex justify-end mt-4">
                <button id="view-chart-btn" class="action-button px-4 py-2">View Chart</button>
            </div>
        </div>
    </div>
    
    <!-- Custom Modal for Prompts -->
    <div id="custom-prompt-modal" class="modal">
        <div class="modal-content">
            <p class="text-gray-800 dark:text-gray-100 text-lg mb-4" id="modal-message">Enter name for the new sub-section:</p>
            <input type="text" id="modal-input" class="w-full px-4 py-2 mb-4 border rounded-lg focus:outline-none focus:ring-2 focus:ring-blue-500 dark:bg-gray-700 dark:border-gray-600 dark:text-gray-100">
            <div class="flex justify-end gap-2">
                <button id="modal-cancel-btn" class="bg-gray-300 dark:bg-gray-600 text-gray-800 dark:text-gray-100 px-4 py-2 rounded-lg hover:bg-gray-400 dark:hover:bg-gray-700">Cancel</button>
                <button id="modal-ok-btn" class="bg-blue-500 text-white px-4 py-2 rounded-lg hover:bg-blue-600">OK</button>
            </div>
        </div>
    </div>
    
    <!-- Help Modal -->
    <div id="help-modal" class="modal">
        <div class="modal-content">
            <h3 id="help-modal-title" class="text-xl font-bold text-gray-800 dark:text-gray-100 mb-4"></h3>
            <div id="help-modal-content" class="text-gray-600 dark:text-gray-300 leading-relaxed overflow-y-auto max-h-[70vh]"></div>
            <div class="flex justify-end mt-4">
                <button id="help-modal-close-btn" class="bg-blue-500 text-white px-4 py-2 rounded-lg hover:bg-blue-600">Close</button>
            </div>
        </div>
    </div>

    <!-- Chart Modal -->
    <div id="chart-modal" class="modal">
        <div class="modal-content">
            <h3 class="text-xl font-bold text-gray-800 dark:text-gray-100 mb-4 text-center">Progress by Status</h3>
            <div class="p-4 rounded-lg bg-gray-50 dark:bg-gray-800">
                <canvas id="progressChart"></canvas>
            </div>
            <div class="flex justify-end mt-4">
                <button id="chart-modal-close-btn" class="bg-blue-500 text-white px-4 py-2 rounded-lg hover:bg-blue-600">Close</button>
            </div>
        </div>
    </div>

    <script type="module">
        import { initializeApp } from "https://www.gstatic.com/firebasejs/11.6.1/firebase-app.js";
        import { getAuth, signInAnonymously, signInWithCustomToken, onAuthStateChanged } from "https://www.gstatic.com/firebasejs/11.6.1/firebase-auth.js";
        import { getFirestore, doc, onSnapshot, setDoc } from "https://www.gstatic.com/firebasejs/11.6.1/firebase-firestore.js";
        
        // Firebase configuration and initialization
        const appId = typeof __app_id !== 'undefined' ? __app_id : 'default-app-id';
        const firebaseConfig = JSON.parse(typeof __firebase_config !== 'undefined' ? __firebase_config : '{}');
        const app = initializeApp(firebaseConfig);
        const db = getFirestore(app);
        const auth = getAuth(app);
        
        const initialSections = [
            { name: 'Title', hasWordCount: false },
            { name: 'Copyright declaration', hasWordCount: false },
            { name: 'Acknowledgements', hasWordCount: false },
            { name: 'Abstract', hasWordCount: true, targetWordCount: 200 },
            { name: 'Contents page', hasWordCount: false },
            { name: 'Introduction', hasWordCount: true, targetWordCount: 1000 },
            { name: 'Literature review', hasWordCount: true, targetWordCount: 3000 },
            { name: 'Methodology', hasWordCount: true, targetWordCount: 1500 },
            { name: 'Findings', hasWordCount: true, targetWordCount: 3500 },
            { name: 'Conclusion', hasWordCount: true, targetWordCount: 1000 },
            { name: 'Appendices', hasWordCount: false }
        ];
        
        const helpTexts = {
            'Title': 'The title of your dissertation is important. Try to keep it brief and precise. Avoid long descriptive titles and make sure it focuses directly on the main point of your dissertation. It is common for dissertations to change their focus as they develop and you modify your original ideas. Do not be afraid to change the original title of your dissertation before you submit it so that it reflects changes in what you did or how you did it.',
            'Copyright declaration': 'Available from Moodle',
            'Acknowledgements': 'A brief statement thanking those people or organisations that have helped you along the way.',
            'Abstract': 'The dissertation should have an abstract of no more than 200 words at the beginning saying:\n• Why the topic is important.\n• The aims of your dissertation.\n• The methods used\n• Key findings',
            'Contents page': 'Each chapter heading should be listed with its page number. The chapters can be called ‘Literature Review’, Findings’ etc., but you may want to consider alternative chapter headings that reflect the content of the chapter.',
            'Introduction': 'Your introduction should draw your reader in and make them interested in what you have to say. Your introduction should provide a clear outline of your topic and your project, including:\n• What your dissertation is about\n• Why the topic is of interest/important (not just to you but to others as well)\n• A brief account of any event or critical moment that spurred you on to further investigation\n• Where your work fits into the broader discipline of sociology or social policy (is it a mainstream topic that has been well researched and much written about or is it a bit offbeat?)\n• What is different about your approach\n• What kinds of evidence you have drawn on\n• The structure of your dissertation',
            'Literature review': 'The purpose of the literature review is to place your dissertation in the context of other relevant work, and to explain the theoretical arguments that provide you with an analytical framework and with a justification for your methodological approach.\n\nIt should be made up of both theoretical and empirical material, drawing out key differences between the positions taken by different writers. It should also include a summary of the relevant findings of any previous research that is relevant, together with an assessment of the quality, usefulness and relevance of that research.\n\nMost students include a separate chapter for their literature review, but you may find that you can integrate a discussion of the relevant literature into other chapters. You should discuss this with your supervisor.\n\nYou will be assessed not only on the range of material you have used, but also on the extent to which you have selected appropriate material and synthesized it into an argument. It should not be a list of disconnected points. You should highlight the ways in which it relates to your dissertation.\n\nThe literature provides a backbone for your dissertation, and you should conclude it with a summary of the main points you have drawn from the literature you have used. You will return to the points you make here later on when you discuss the findings from your own research.\n\nYou will receive feedback on this chapter in semester 1.',
            'Methodology': 'In this section you should provide a transparent discussion of how you approached and carried out your research and clearly explain why you used these methods. You must draw upon methodological literature. Your explanation should focus on how your method(s) were intended to produce evidence that relates to your research question. You should also consider the advantages and disadvantages of using the method(s) that you did, as well as any ethical issues.\n\nIt does not need to be a methodology essay, but you should demonstrate your understanding of the practical and epistemological issues raised by your choice of method(s). You need to explain what you did to generate data as well as the reasons for approaching the given topic in this way. The latter should involve some consideration of the epistemological basis for your project.\n\nThis chapter will also be sent to your supervisor feedback (in semester 2)',
            'Findings': 'You may wish to present your findings in one chapter and discuss your finidngs (in relation to existing literature) in another chapter. This is more common in quant research. If so, your findings chapters will be as follows:\n‘Presentation of findings’\n‘Discussion of findings’\n\nAlternatively, you may wish to present and discuss your findings in one chapter – this is more common in qual research. Both approaches are acceptable.\n\nHave a look at examples on Moodle.\n\nWhen discussing your findings, you do so by making connections between your findings and the literature you reviewed. This is where your argument moves towards some conclusions that address your research question directly and explicitly. The relationship between research question, literature review, methodology and findings should be set out coherently, with an honest assessment of the limitations of what you have done.\n\nYour supervisor will also provide feedback on your findings chapter.',
            'Conclusion': 'The conclusion is a vital part of the dissertation. It is the place where you can reflect on what you have achieved and any insights generated by your reading of the literature and your findings. It should not set out any new arguments or introduce significant new material. You may wish to include implications for future research and where relevant, implications for policy/practice. You should also provide an overview of key limitations. Ensure that you allow space to adequately discuss your conclusions.',
            'Appendices': 'You may also wish to include some material in appendices. An appendix is a way of providing additional information which is not necessary to read the dissertation, but which is of value in clarifying some of the arguments by adding detail. You do not need to have an appendix, and you should only use them to provide additional information about your research. Such information might include a glossary, a list of acronyms, brief biographies of interview respondents, statistical information, or a copy of a questionnaire or interview schedule you have used. Appendices do not contribute to your final word count.\n\nDo not include interview transcripts as these may be confidential, but you should retain any audio tapes or transcripts as you may be required to present these as proof of conducting the interviews.\n\nIf you did any fieldwork you can provide more details in an appendix than are in your methodology section, such as a description of the place where you carried out your interviews, or a location that you chose for a case study.'
        };

        const colors = ['red-500', 'orange-500', 'yellow-500', 'lime-500', 'green-700'];
        const progressTree = document.getElementById('progress-tree');
        const totalWordCountElement = document.getElementById('total-word-count');
        
        const modal = document.getElementById('custom-prompt-modal');
        const modalMessage = document.getElementById('modal-message');
        const modalInput = document.getElementById('modal-input');
        const modalOkBtn = document.getElementById('modal-ok-btn');
        const modalCancelBtn = document.getElementById('modal-cancel-btn');
        let resolveModalPromise;
        let userId;

        const helpModal = document.getElementById('help-modal');
        const helpModalTitle = document.getElementById('help-modal-title');
        const helpModalContent = document.getElementById('help-modal-content');
        const helpModalCloseBtn = document.getElementById('help-modal-close-btn');

        const chartModal = document.getElementById('chart-modal');
        const chartModalCloseBtn = document.getElementById('chart-modal-close-btn');
        const viewChartBtn = document.getElementById('view-chart-btn');
        let progressChartInstance = null;

        // Theme toggle
        const themeToggleBtn = document.getElementById('theme-toggle');
        const body = document.body;
        const container = document.querySelector('.container');

        const savedTheme = localStorage.getItem('theme');
        if (savedTheme) {
            body.classList.add(savedTheme);
            container.classList.add(savedTheme);
        } else if (window.matchMedia && window.matchMedia('(prefers-color-scheme: dark)').matches) {
            body.classList.add('dark');
            container.classList.add('dark');
        }

        themeToggleBtn.addEventListener('click', () => {
            body.classList.toggle('dark');
            container.classList.toggle('dark');
            const newTheme = body.classList.contains('dark') ? 'dark' : 'light';
            localStorage.setItem('theme', newTheme);
        });

        function generateId() {
            return '_' + Math.random().toString(36).substr(2, 9);
        }
        
        async function saveState() {
            if (!userId) {
                console.log("User not authenticated, cannot save state.");
                return;
            }
            const data = [];
            document.querySelectorAll('#progress-tree li').forEach(item => {
                const button = item.querySelector('.progress-button');
                const wordCountInput = item.querySelector('.word-count-input.current-wc');
                const targetWordCountInput = item.querySelector('.word-count-input.target-wc');
                const id = item.dataset.id;
                const parentId = item.dataset.parentId || null;
                const name = button.dataset.name;
                const colorIndex = button.dataset.colorIndex;
                const hasWordCount = item.dataset.hasWordCount === 'true';
                const wordCount = wordCountInput ? wordCountInput.value : null;
                const targetWordCount = targetWordCountInput ? targetWordCountInput.value : null;

                data.push({
                    id,
                    parentId,
                    name,
                    colorIndex,
                    hasWordCount,
                    wordCount,
                    targetWordCount
                });
            });

            // Save to local storage as a backup
            localStorage.setItem('dissertation-progress', JSON.stringify(data));
            
            try {
                await setDoc(doc(db, "artifacts", appId, "users", userId, "dissertationData", "progress"), { data: JSON.stringify(data) });
            } catch (e) {
                console.error("Error saving document to Firestore: ", e);
            }
        }

        function renderState(data) {
            progressTree.innerHTML = '';
            const itemMap = {};
            
            // First pass: create all list items and map them by ID
            data.forEach(item => {
                const li = createProgressItem(item.name, item.hasWordCount, item.id, item.parentId, true);
                itemMap[item.id] = li;
            });

            // Second pass: append to correct parent
            data.forEach(item => {
                const li = itemMap[item.id];
                li.querySelector('.progress-button').dataset.colorIndex = item.colorIndex; 
                if (item.wordCount !== null) {
                    li.querySelector('.word-count-input.current-wc').value = item.wordCount;
                    li.querySelector('.word-count-input.target-wc').value = item.targetWordCount || '0';
                }

                if (item.parentId && itemMap[item.parentId]) {
                    let parentUl = itemMap[item.parentId].querySelector('ul');
                    if (!parentUl) {
                        parentUl = document.createElement('ul');
                        parentUl.className = 'progress-list';
                        itemMap[item.parentId].appendChild(parentUl);
                    }
                    parentUl.appendChild(li);
                } else {
                    progressTree.appendChild(li);
                }
                updateButtonColor(li.querySelector('.progress-button'));
            });
            updateParentCountsAndDisplay();
        }

        function createProgressItem(name, hasWordCount, id = generateId(), parentId = null, fromLoad = false) {
            const li = document.createElement('li');
            li.className = 'progress-item';
            li.dataset.id = id;
            if (parentId) {
                li.dataset.parentId = parentId;
            }
            li.dataset.hasWordCount = hasWordCount;

            const buttonWrapper = document.createElement('div');
            buttonWrapper.className = 'button-wrapper';

            const button = document.createElement('button');
            button.className = 'progress-button ' + 'bg-' + colors[0];
            button.dataset.colorIndex = 0;
            button.dataset.name = name;
            
            updateButtonText(button, name, 0, 0);
            
            button.onclick = () => {
                const newIndex = (parseInt(button.dataset.colorIndex) + 1) % colors.length;
                button.dataset.colorIndex = newIndex;
                updateButtonColor(button);
                saveState();
            };
            buttonWrapper.appendChild(button);

            const actionsContainer = document.createElement('div');
            actionsContainer.className = 'flex gap-2';
            buttonWrapper.appendChild(actionsContainer);

            if (hasWordCount) {
                const inputGroup = document.createElement('div');
                inputGroup.className = 'input-group';
                
                const currentWcContainer = document.createElement('div');
                currentWcContainer.className = 'word-count-input-container';
                const currentWCLabel = document.createElement('label');
                currentWCLabel.textContent = 'Current WC:';
                const currentWCInput = document.createElement('input');
                currentWCInput.type = 'number';
                currentWCInput.className = 'word-count-input current-wc';
                currentWCInput.placeholder = '0';
                currentWCInput.value = '0';
                currentWCInput.min = '0';
                currentWCInput.oninput = () => {
                    if (currentWCInput.value === '' || parseInt(currentWCInput.value) < 0) {
                        currentWCInput.value = 0;
                    }
                    updateParentCountsAndDisplay();
                    saveState();
                };
                currentWcContainer.appendChild(currentWCLabel);
                currentWcContainer.appendChild(currentWCInput);
                inputGroup.appendChild(currentWcContainer);

                const targetWcContainer = document.createElement('div');
                targetWcContainer.className = 'word-count-input-container';
                const targetWCLabel = document.createElement('label');
                targetWCLabel.textContent = 'Target WC:';
                const targetWCInput = document.createElement('input');
                targetWCInput.type = 'number';
                targetWCInput.className = 'word-count-input target-wc';
                targetWCInput.placeholder = '0';
                targetWCInput.value = '0';
                targetWCInput.min = '0';
                targetWCInput.oninput = () => {
                    if (targetWCInput.value === '' || parseInt(targetWCInput.value) < 0) {
                        targetWCInput.value = 0;
                    }
                    saveState();
                };
                targetWcContainer.appendChild(targetWCLabel);
                targetWcContainer.appendChild(targetWCInput);
                inputGroup.appendChild(targetWcContainer);

                actionsContainer.appendChild(inputGroup);
            }
            
            const addSubsectionBtn = document.createElement('button');
            addSubsectionBtn.className = 'action-button';
            addSubsectionBtn.textContent = '+ Sub';
            addSubsectionBtn.onclick = async () => {
                const subsectionName = await showCustomPrompt('Enter the name for the new sub-section:');
                if (subsectionName) {
                    const newSubsection = createProgressItem(subsectionName, true, generateId(), id);
                    let ul = li.querySelector('ul');
                    if (!ul) {
                        ul = document.createElement('ul');
                        ul.className = 'progress-list';
                        li.appendChild(ul);
                    }
                    ul.appendChild(newSubsection);
                    saveState();
                    updateParentCountsAndDisplay();
                }
            };
            actionsContainer.appendChild(addSubsectionBtn);
            
            const renameBtn = document.createElement('button');
            renameBtn.className = 'action-button';
            renameBtn.textContent = 'Rename';
            renameBtn.onclick = async () => {
                const newName = await showCustomPrompt('Rename section:');
                if (newName) {
                    button.dataset.name = newName;
                    updateButtonText(button, newName, 0, 0);
                    updateParentCountsAndDisplay();
                    saveState();
                }
            };
            actionsContainer.appendChild(renameBtn);

            const helpBtn = document.createElement('button');
            helpBtn.className = 'action-button';
            helpBtn.textContent = 'Help';
            helpBtn.onclick = () => {
                const sectionName = button.dataset.name;
                const helpText = helpTexts[sectionName];
                if (helpText) {
                    showHelpPrompt(sectionName, helpText);
                } else {
                    showHelpPrompt(sectionName, "No help information available for this section.");
                }
            };
            actionsContainer.appendChild(helpBtn);


            const deleteBtn = document.createElement('button');
            deleteBtn.className = 'delete-btn';
            deleteBtn.textContent = 'x';
            deleteBtn.onclick = () => {
                li.remove();
                updateParentCountsAndDisplay();
                saveState();
            };
            buttonWrapper.appendChild(deleteBtn);

            li.appendChild(buttonWrapper);
            return li;
        }
        
        function updateButtonColor(button) {
            button.classList.remove(...colors.map(c => 'bg-' + c));
            const colorIndex = parseInt(button.dataset.colorIndex);
            button.classList.add('bg-' + colors[colorIndex]);
        }

        function updateButtonText(button, name, count, targetCount) {
            const originalName = button.dataset.name;
            if (button.dataset.hasWordCount === 'true') {
                button.innerHTML = `
                    <span class="text-lg">${originalName}</span>
                    <span class="word-count-display">${count.toLocaleString()} / ${targetCount.toLocaleString()} words</span>
                `;
            } else {
                button.textContent = originalName;
            }
        }
        
        function calculateAndPropagateCount(item) {
            let total = 0;
            const hasWordCount = item.dataset.hasWordCount === 'true';
            const button = item.querySelector('.progress-button');

            if (hasWordCount) {
                total += parseInt(item.querySelector('.word-count-input.current-wc').value) || 0;
            }
            
            const sublist = item.querySelector('ul.progress-list');
            if (sublist) {
                sublist.querySelectorAll(':scope > li').forEach(subItem => {
                    total += calculateAndPropagateCount(subItem);
                });
            }
            
            const targetCount = hasWordCount ? (parseInt(item.querySelector('.word-count-input.target-wc').value) || 0) : 0;
            updateButtonText(button, button.dataset.name, total, targetCount);
            return total;
        }
        
        function updateParentCountsAndDisplay() {
            let totalWordCount = 0;
            const topLevelItems = document.querySelectorAll('#progress-tree > li');
            topLevelItems.forEach(item => {
                totalWordCount += calculateAndPropagateCount(item);
            });
            totalWordCountElement.textContent = totalWordCount.toLocaleString();
        }

        // --- Custom Prompt Functions ---
        function showCustomPrompt(message) {
            return new Promise((resolve) => {
                modal.classList.add('active');
                modalMessage.textContent = message;
                modalInput.value = '';
                modalInput.focus();
                
                resolveModalPromise = resolve;
            });
        }

        function showHelpPrompt(title, text) {
            helpModalTitle.textContent = title;
            helpModalContent.innerHTML = text.replace(/\n/g, '<br>');
            helpModal.classList.add('active');
        }

        helpModalCloseBtn.onclick = () => {
            helpModal.classList.remove('active');
        };
        
        modalOkBtn.onclick = () => {
            modal.classList.remove('active');
            resolveModalPromise(modalInput.value);
        };
        
        modalCancelBtn.onclick = () => {
            modal.classList.remove('active');
            resolveModalPromise(null);
        };
        
        modalInput.onkeydown = (e) => {
            if (e.key === 'Enter') {
                modalOkBtn.click();
            }
        };

        // --- Chart Functions ---
        function updateChart() {
            const progressCounts = [0, 0, 0, 0, 0];
            document.querySelectorAll('.progress-button').forEach(button => {
                const colorIndex = parseInt(button.dataset.colorIndex);
                if (!isNaN(colorIndex) && colorIndex >= 0 && colorIndex < progressCounts.length) {
                    progressCounts[colorIndex]++;
                }
            });

            const labels = ['Not Looked At', 'Started Research', '1st Draft', '2nd Draft', 'Completed'];
            const backgroundColors = ['#ef4444', '#f97316', '#eab308', '#84cc16', '#15803d'];

            if (progressChartInstance) {
                progressChartInstance.destroy();
            }

            const ctx = document.getElementById('progressChart').getContext('2d');
            progressChartInstance = new Chart(ctx, {
                type: 'pie',
                data: {
                    labels: labels,
                    datasets: [{
                        data: progressCounts,
                        backgroundColor: backgroundColors,
                        hoverOffset: 4
                    }]
                },
                options: {
                    responsive: true,
                    plugins: {
                        legend: {
                            position: 'top',
                            labels: {
                                font: {
                                    family: 'Copperplate, "Copperplate Gothic Light", serif',
                                    size: 14,
                                },
                                color: document.body.classList.contains('dark') ? '#e5e5f0' : '#1f2937'
                            }
                        },
                        tooltip: {
                            callbacks: {
                                label: function(context) {
                                    let label = context.label || '';
                                    if (label) {
                                        label += ': ';
                                    }
                                    if (context.parsed !== null) {
                                        label += context.parsed;
                                    }
                                    return label;
                                }
                            }
                        }
                    }
                }
            });
            chartModal.classList.add('active');
        }
        
        viewChartBtn.addEventListener('click', updateChart);
        
        chartModalCloseBtn.addEventListener('click', () => {
            chartModal.classList.remove('active');
        });


        // Initialize Firebase Authentication and data listener
        onAuthStateChanged(auth, async (user) => {
            if (user) {
                userId = user.uid;
                document.getElementById('user-id-display').textContent = `User ID: ${userId}`;
                document.getElementById('user-id-display').classList.remove('hidden');

                // Try to load from local storage first for a faster render
                let localData = null;
                try {
                    const localSavedState = localStorage.getItem('dissertation-progress');
                    if (localSavedState) {
                        localData = JSON.parse(localSavedState);
                        renderState(localData);
                    }
                } catch (e) {
                    console.error('Error parsing local storage data:', e);
                }

                // Listen for real-time changes to the data from Firestore
                onSnapshot(doc(db, "artifacts", appId, "users", userId, "dissertationData", "progress"), async (snapshot) => {
                    if (snapshot.exists()) {
                        const firebaseData = JSON.parse(snapshot.data().data);
                        // Update local storage with the latest cloud data
                        localStorage.setItem('dissertation-progress', JSON.stringify(firebaseData));
                        renderState(firebaseData);
                    } else {
                        // If cloud data doesn't exist, check for a local backup
                        if (localData) {
                            console.log("Restoring data from local backup.");
                            await setDoc(doc(db, "artifacts", appId, "users", userId, "dissertationData", "progress"), { data: JSON.stringify(localData) });
                        } else {
                            // No cloud or local data, create initial structure and save to both
                            const initialData = initialSections.map(s => ({
                                id: generateId(),
                                parentId: null,
                                name: s.name,
                                colorIndex: 0,
                                hasWordCount: s.hasWordCount,
                                wordCount: s.hasWordCount ? '0' : null,
                                targetWordCount: s.hasWordCount ? (s.targetWordCount || '0') : null
                            }));
                            localStorage.setItem('dissertation-progress', JSON.stringify(initialData));
                            renderState(initialData);
                            await setDoc(doc(db, "artifacts", appId, "users", userId, "dissertationData", "progress"), { data: JSON.stringify(initialData) });
                        }
                    }
                });
            } else {
                try {
                    const token = typeof __initial_auth_token !== 'undefined' ? __initial_auth_token : null;
                    if (token) {
                        await signInWithCustomToken(auth, token);
                    } else {
                        await signInAnonymously(auth);
                    }
                } catch (error) {
                    console.error("Firebase Auth Error:", error);
                }
            }
        });
    </script>
</body>
</html>
